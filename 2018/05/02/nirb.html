<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Nirb | glob</title>
<meta name="generator" content="Jekyll v3.8.0" />
<meta property="og:title" content="Nirb" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The interactive_editor gem lets you launch an instance of Vim within an IRB session." />
<meta property="og:description" content="The interactive_editor gem lets you launch an instance of Vim within an IRB session." />
<link rel="canonical" href="http://ivanbrennan.github.io/2018/05/02/nirb.html" />
<meta property="og:url" content="http://ivanbrennan.github.io/2018/05/02/nirb.html" />
<meta property="og:site_name" content="glob" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-02T23:39:11-04:00" />
<script type="application/ld+json">
{"description":"The interactive_editor gem lets you launch an instance of Vim within an IRB session.","@type":"BlogPosting","url":"http://ivanbrennan.github.io/2018/05/02/nirb.html","headline":"Nirb","dateModified":"2018-05-02T23:39:11-04:00","datePublished":"2018-05-02T23:39:11-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://ivanbrennan.github.io/2018/05/02/nirb.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://ivanbrennan.github.io/feed.xml" title="glob" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">glob</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Nirb</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-05-02T23:39:11-04:00" itemprop="datePublished">May 2, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The <a href="https://github.com/jberkel/interactive_editor">interactive_editor</a> gem lets you launch an instance of Vim within an IRB session.</p>

<p>It brings up a scratch buffer, and when you <code class="highlighter-rouge">:wq</code> (save+quit) Vim, you’re back in IRB, with any methods/classes you defined now available.
Even better, if you relaunch Vim it will load the code you were editing previously, make it easy to work incrementally and try ideas out in the repl.</p>

<p>To use this on NixOS, I needed to write a nix derivation for it.
So I created a simple Gemfile:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>interactive-editor <span class="o">&amp;&amp;</span>
    <span class="nb">cd </span>interactive-editor <span class="o">&amp;&amp;</span>
    <span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; Gemfile
source 'https://rubygems.org'
gem 'interactive_editor'
</span><span class="no">EOF
</span></code></pre></div></div>
<p>Then I used <code class="highlighter-rouge">bundix</code> to generate a gemset.nix describing interactive_editor and its dependencies.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nix-shell <span class="nt">--packages</span> bundix <span class="nt">--run</span> <span class="s1">'bundix --magic'</span>
<span class="nb">chmod </span>644 gemset.nix
</code></pre></div></div>
<p>The <code class="highlighter-rouge">chmod</code> is a workaround for a small bug in <code class="highlighter-rouge">bundix</code> that creates gemset.nix with 0600 permissions, preventing read access for users other than the file owner.
Since I want a root-owned copy of this file incorporated into my nixos configuration, setting 0644 permissions ensures non-root users can still use it.</p>

<p>I submitted <a href="https://github.com/manveru/bundix/pull/29">a fix</a> to bundix for the permissions issue, but until the fixed version makes it into the nixpkgs tree, <code class="highlighter-rouge">chmod</code> does the trick.</p>

<p>Next, I copied Gemfile, Gemfile.lock, and gemset.nix into an overlay in my nixos confg.
I keep most of my custom packages in an overlay under <code class="highlighter-rouge">/etc/nixos/overlays/core/</code>.
I copied the relevant files to an <code class="highlighter-rouge">interactive-editor/</code> subdirectory, and wrote a derivation with <code class="highlighter-rouge">bundlerEnv</code> in default.nix:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>bash <span class="nt">-c</span> <span class="s1">'
    mkdir /etc/nixos/overlays/core/interactive-editor &amp;&amp;
        cp /home/ivan/path/to/interactive-editor/{Gemfile{,.lock},gemset.nix} \
           /etc/nixos/overlays/interactive-editor/
        cat &lt;&lt;"EOF" &gt; /etc/nixos/overlays/interactive-editor/default.nix
{ lib, bundlerEnv, ruby }:

bundlerEnv rec {
  name = "interactive-editor-${version}";

  version = (import gemset).interactive-editor.version;
  inherit ruby;
  # expects Gemfile, Gemfile.lock and gemset.nix in the same directory
  gemdir = ./.;

  meta = with lib; {
    description = "Interactive editing in irb";
    homepage    = http://github.com/jberkel/interactive_editor;
    license     = with licenses; mit;
    platforms   = platforms.unix;
  };
}
EOF
'</span>
</code></pre></div></div>
<p>I should call out a small gotcha in the above bash snippet. The opening heredoc delimiter needs to be quoted (<code class="highlighter-rouge">"EOF"</code>), otherwise Bash will try to expand <code class="highlighter-rouge">${version}</code> and substitute the expansion (an empty string, since we haven’t defined any such variable in our shell) in the text we’re writing to default.nix.</p>

<p>We want the <code class="highlighter-rouge">${version}</code> to be inserted literally (it’s a Nix variable, not a Bash variable).
This is made all the more confusing by the fact that the heredoc is already inside a single-quoted block.
We’re using the single-quotes to wrap a block of code we want Bash to interpret (<code class="highlighter-rouge">bash -c '...'</code>).
This way, <code class="highlighter-rouge">sudo</code> runs <code class="highlighter-rouge">mkdir</code>, <code class="highlighter-rouge">cp</code>, and <code class="highlighter-rouge">cat</code> all with elevated privileges.</p>

<p>With the derivation in place, I added it to my <a href="https://github.com/ivanbrennan/nixbox/blob/91f8f3b12f167fbae1643ee8ba559dffc556e089/overlays/core/default.nix#L4">overlay</a>:</p>
<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">self</span><span class="p">:</span> <span class="nv">super</span><span class="p">:</span> <span class="p">{</span>
  <span class="c"># ...</span>

  <span class="nv">interactive-editor</span> <span class="o">=</span> <span class="nv">super</span><span class="o">.</span><span class="nv">callPackage</span> <span class="sx">./interactive-editor</span> <span class="p">{</span> <span class="p">};</span>

  <span class="c"># ...</span>
<span class="p">}</span>
</code></pre></div></div>
<p>I <a href="https://github.com/ivanbrennan/nixbox/commit/f63c0a6c873958bef9e13b5c117ada60e4e92442">aliased</a> <code class="highlighter-rouge">nirb</code> to launch IRB with interactive_editor available:</p>
<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">nix-shell</span> <span class="o">--</span><span class="nv">packages</span> <span class="nv">ruby</span> <span class="nv">interactive-editor</span> <span class="o">--</span><span class="nv">command</span> <span class="nv">irb</span>
</code></pre></div></div>
<p>Finally, in order for <code class="highlighter-rouge">nix-shell</code> to find packages in my overlay, I <a href="https://github.com/ivanbrennan/nixbox/blob/91f8f3b12f167fbae1643ee8ba559dffc556e089/configuration.nix#L46">added a nixpkgs-overlays</a> entry to my NIX_PATH.</p>

  </div><a class="u-url" href="/2018/05/02/nirb.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">glob</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">glob</li><li><a class="u-email" href="mailto:"></a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ivanbrennan"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ivanbrennan</span></a></li><li><a href="https://www.twitter.com/"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username"></span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>blog</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
