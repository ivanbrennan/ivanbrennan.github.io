
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>codemachine</title>
  <meta name="author" content="Ivan Brennan">

  
  <meta name="description" content="I&rsquo;ve been using ctags to navigate the codebases I work with in Vim for a couple years, largely thanks to a blog post by Tim Pope where he &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ivanbrennan.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="codemachine" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">codemachine</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ivanbrennan.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/20/debugging-etags/">Debugging-etags</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-12-20T07:52:00-05:00" pubdate data-updated="true">Dec 20<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been using ctags to navigate the codebases I work with in Vim for a couple years, largely thanks to a <a href="http://tbaggery.com/2011/08/08/effortless-ctags-with-git.html">blog post</a> by Tim Pope where he describes how to use git hooks to keep your tags up-to-date. Omitting a few details, the script I use boils down to this:</p>

<pre><code>git ls-files | ctags -L - -o ".git/tags" --tag-relative=yes --languages=-javascript,sql
</code></pre>

<p>On a large Rails app I&rsquo;ve been working with, it takes 1 second and generates a 7MB tags file.</p>

<p>More recently, I started playing around with Emacs, and I&rsquo;ve been looking for a way to port my tagging strategy over to <em>e</em>tags. There are a few ways you can generate etags. Emacs comes with its own <code>etags</code> executable, but the more featureful implementations of ctags can also generate etags.</p>

<p>I&rsquo;ve been using <a href="https://github.com/universal-ctags/ctags">universal-ctags</a>, which picked up where <a href="http://ctags.sourceforge.net">exuberant-ctags</a> left off a few years ago, adding more language support, so I added <code>-e</code> to my tagging command and gave that a try.</p>

<p>It took 90 seconds and produced an <strong><em>8GB</em></strong> tags file. At first, I thought this must be a problem with the etags format itself, but when I tried Emacs&#8217; own <code>etags</code> executable, it took 13 seconds and produced a 3MB file. Next, I tried exuberant-ctags, which took 2 seconds and produced a 1MB file.</p>

<p>Narrowing in on the problem was an interesting process that pulled together several shell scripting concepts and tools, including redirection, sub-shells, and <code>awk</code>.</p>

<p>The first step was to generate performance stats to profile each file&rsquo;s contribution to execution time and tags file-size. I wanted a list of records like:</p>

<pre><code>some_file.rb &lt;- source-file
0.004        &lt;- processing time (seconds)
8159         &lt;- source file-size (bytes)
13389        &lt;- tags file-size (bytes)

another_file.rb
0.002
345
4859

...
</code></pre>

<p>To generate these stats, I ran a shell script that iterated through the files, generating tags for each in turn, and appending stats to a running log file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>f in <span class="k">$(</span>git ls-files<span class="k">)</span>
</span><span class='line'><span class="k">do</span>
</span><span class='line'>  <span class="o">(</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span>
</span><span class='line'>    <span class="o">(</span> <span class="nv">TIMEFORMAT</span><span class="o">=</span><span class="s1">&#39;%R&#39;</span>
</span><span class='line'>      <span class="nb">time </span>ctags -e -o tmp.TAGS --tag-relative<span class="o">=</span>yes --languages<span class="o">=</span>-javascript,sql <span class="nv">$f</span> <span class="o">)</span>
</span><span class='line'>    <span class="o">(</span> ls -l <span class="nv">$f</span>
</span><span class='line'>      ls -l tmp.TAGS <span class="o">)</span> | awk <span class="s1">&#39;{ print $5 }&#39;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="o">)</span> &gt;&gt; etagging.log 2&gt;&amp;1
</span><span class='line'>  rm tmp.TAGS
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll break this down a bit.</p>

<p>First we run <code>git ls-files</code> in a sub-shell to generate the list of files we&rsquo;ll be iterating over:</p>

<pre><code>for f in $(git ls-files)
</code></pre>

<p>On each iteration, we run a few commands to generate performance stats and append their output to a log file named <code>etagging.log</code>. This could be done like,</p>

<pre><code>run a command &gt;&gt; etagging.log
run another command &gt;&gt; etagging.log
run one more command &gt;&gt; etagging.log
</code></pre>

<p>but by using a sub-shell, we can do the same with a single <code>&gt;&gt;</code> indirection operator.</p>

<pre><code>( run a command
  run another command
  run one more command ) &gt;&gt; etagging.log
</code></pre>

<p>I&rsquo;m using the <code>time</code> command to record the time spent processing each file, and this introduces some extra complexity. For one, I only want the real (perceived) time, and because I&rsquo;m using the shell&rsquo;s <code>time</code> built-in, I need to set the <code>TIMEFORMAT</code> shell variable to acheive this.</p>

<p>Furthermore, <code>time</code> prints its results to stderr rather than stdout. If I simply used <code>&gt;&gt;</code> as above, the time stats would print to my terminal rather than to the logfile. To redirect stderr to the log file as well, the form changes to:</p>

<pre><code>( run a command
  run another command
  run one more command ) &gt;&gt; etagging.log 2&gt;&amp;1
</code></pre>

<p>You could read this as, &ldquo;Run these commands in a sub-shell, send the sub-shell&rsquo;s standard output data to a log file, and send the standard error data to the same location you&rsquo;re sending the standard output.&rdquo;</p>

<p>The <code>2</code> and <code>1</code> above are &ldquo;file-descriptors&rdquo; that indicate stderr and stdout, respectively. Think of a file-descriptor as a numeric identifier associated with a particular stream of data. If you&rsquo;re familiar with pointers in C, you could think of <code>&amp;1</code> as the location of stdout. Thus, <code>2&gt;&amp;1</code> says to redirect stderr to the same place that stdout is headed.</p>

<p>The order of the redirection commands is important. If we&rsquo;d written,</p>

<pre><code>( run some commands ) 2&gt;&amp;1 &gt;&gt; etagging.log
</code></pre>

<p>then stderr would redirected to the same location as stdout (<code>2&gt;&amp;1</code>) <em>before</em> we&rsquo;d changed stdout to point to the log file. It would be like saying, &ldquo;Hey stderr, see the river stdout is headed towards? Go there. Hey stdout, change direction, go the that hilltop.&rdquo;</p>

<p>After the time stats have been generated, we want to include the size of the source file as well as of the generated tags file:</p>

<pre><code>( ls -l $f
  ls -l tmp.TAGS ) | awk '{ print $5 }'
</code></pre>

<p>This produces long-format file-listings, and we pipe the results to <code>awk</code> to extract the 5th field from each line, which happens to the number of bytes in the file.</p>

<p>Once the script has run to completion, I&rsquo;d like to sort the results by time and tag-size. The <code>sort</code> command expects newline-separated records with whitespace-separated fields. We can use <code>awk</code> to translate our results to the horizontal format <code>sort</code> expects.</p>

<pre><code>awk 'BEGIN { RS=""; FS="\n" } { print $1, $2, $3, $4 }' etagging.log
</code></pre>

<p>We&rsquo;re using a <code>BEGIN</code> block to set up awk&rsquo;s <code>RS</code> (record-separator) and <code>FS</code> (field-separator) variables, allowing it to correctly identify each record. The next block defines the actions we want to take on each record, namely to print each of its fields on a single line. We can pipe this into <code>sort</code> and generate stats sorted by time:</p>

<pre><code>awk 'BEGIN { RS=""; FS="\n" } { print $1, $2, $3, $4 }' etagging.log | sort -nrk2 &gt; etagging-time
</code></pre>

<p>Here we&rsquo;re telling <code>sort</code> to sort numerically, in reverse order, treating the 2nd field (time) as the sort-key. We can do the same for tag file size, the 4th field:</p>

<pre><code>awk 'BEGIN { RS=""; FS="\n" } { print $1, $2, $3, $4 }' etagging.log | sort -nrk4 &gt; etagging-size
</code></pre>

<p>Finally, we can take a look at what floated to the top.</p>

<pre><code>$ head -n 3 etagging-time
app/models/taxi_edit.json 108.024 273517 8084569921
vendor/assets/stylesheets/bootstrap/bootstrap.min.css 2.159 118153 288792277
app/models/appointment.rb 0.252 10096 2481

$ head -n 3 etagging-size
app/models/taxi_edit.json 108.024 273517 8084569921
vendor/assets/stylesheets/bootstrap/bootstrap.min.css 2.159 118153 288792277
vendor/assets/stylesheets/intlTelInput.css 0.051 18194 5464144
</code></pre>

<p>As you can see, the top two offenders, both by time and by size, are a large json file and a minified bootstrap stylesheet, neither of which I have much interest in tagging. This shed some light on the performance disparity between universal-ctags and other tagging libraries, as universal-ctags recently added json support, so it was the only implementation tagging json at all.</p>

<p>A quick fix is to add json to the languages I exclude from tagging, but it begged the question, why didn&rsquo;t it have the same problem when run without the <code>-e</code> flag? Turns out the issue was extremely long lines in the source files. The tags file includes a source line reference, and it truncates these references when outputting <em>c</em>tags, but not when outputting <em>e</em>tags.</p>

<p>I reported the issue to the universal-ctags project (they were, in fact, very helpful during the debugging process as well).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/06/karabiner/">Karabiner</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-06T14:45:00-04:00" pubdate data-updated="true">Jun 6<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A while back I stopped using &ldquo;jk&rdquo; to exit Vim&rsquo;s insert-mode, turning instead to the mostly-useless <code>Caps Lock</code>. I set it to be <code>Control</code>, then used <a href="https://pqrs.org/osx/karabiner/">Karabiner</a> to turn it into a dual-purpose <code>Control</code>/<code>Escape</code>. Typed by itself, it&rsquo;s <code>Escape</code>; in concert with another key it&rsquo;s <code>Control</code>. The boost in comfort and productivity has been huge.</p>

<p>Bringing <code>Escape</code> closer to home feels like a more sensible solution, and I&rsquo;m no longer typing &ldquo;jk&rdquo; all over the place when my fingers forget they&rsquo;re not in Vim. The productivity gains, however, are largely the result of having a <code>Control</code> key that&rsquo;s so accessible. It&rsquo;s opened up my use of control-modified commands like Vim&rsquo;s autocompletion and the shell&rsquo;s reverse-incremental-search quite a bit.</p>

<p>To set this up on OS X, first go to the Keyboard pane of System Preferences and change <code>Caps Lock</code> to <code>Control</code>.</p>

<p><img class="caps-lock" src="/images/karabiner/caps-lock.png" title="caps-lock" alt="caps-lock"></p>

<p>Then use Karabiner to send <code>Escape</code> when you type <code>Control</code> by itself.</p>

<pre><code>* karabiner preferences -&gt; "Change Key" tab
* scroll down to "Change Control_L Key (Left Control)"
* check "Control_L to Control_L (+ When you type Control_L only, send Escape)"
</code></pre>

<p><img class="escape" src="/images/karabiner/escape.png" title="escape" alt="escape"></p>

<h2>More Control</h2>

<p>I recently took this one step further and turned my <code>Return</code> key into a dual-purpose <code>Control</code>/<code>Return</code>, giving me easy access to a <code>Control</code> key on either side of the keyboard.</p>

<p><img class="return" src="/images/karabiner/return.png" title="return" alt="return"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/04/unix-know-how/">Unix Know-how</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-04T22:48:00-05:00" pubdate data-updated="true">Nov 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was working with MySQL queries that involved timezone conversion when I noticed that my local instance of MySQL didn&rsquo;t recognize named timezones. Queries with named timezones were returning <code>null</code>, while those with numeric offsets from UTC were returning correct conversions:</p>

<pre><code>&gt; SELECT CONVERT_TZ('2014-01-01 12:00:00', 'America/New_York', 'UTC');
=&gt; null

&gt; SELECT CONVERT_TZ('2014-01-01 12:00:00', '-5:00', '+00:00');
=&gt; 2014-01-01 17:00:00
</code></pre>

<p>I hadn&rsquo;t loaded my system&rsquo;s zoneinfo files into the <code>mysql</code> database. As per the <a href="http://dev.mysql.com/doc/refman/5.5/en/time-zone-support.html">docs</a>, I used the <code>mysql_tzinfo_to_sql</code> utility to load them from <code>/usr/share/zoneinfo</code>:</p>

<pre><code>$ mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root mysql
</code></pre>

<p>The process failed before loading all the tables:</p>

<pre><code>ERROR 1406 (22001) at line 38408: Data too long for column 'Abbreviation' at row 1
</code></pre>

<p>Now I could reference <code>America/New_York</code>, but not <code>UTC</code>, since the process had failed before loading that table. A coworker suggested I write the command&rsquo;s output to a file so I could debug:</p>

<pre><code>$ mysql_tzinfo_to_sql /usr/share/zoneinfo &gt; debuggingfile
</code></pre>

<p>The <code>debuggingfile</code> contained many insert statements, and line 38408 revealed the problem:</p>

<pre><code>INSERT INTO time_zone_transition_type (Time_zone_id, Transition_type_id, Offset, Is_DST, Abbreviation) VALUES (@time_zone_id, 0, 0, 0, 'Local time zone must be set--see zic manual page');
</code></pre>

<p>The <code>'Local time zone must be set--see zic manual page'</code> value was too long for the Abbreviation column. I shortened it to <code>'unset'</code>, fed the file into mysql, and all was well.</p>

<pre><code>$ mysql -u root mysql &lt; debuggingfile
</code></pre>

<p>I was struck by the simplicity of this solution, and how a little unix know-how can demystify a problem.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/04/search-and-replace/">Search &amp; Replace</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-04T08:05:00-05:00" pubdate data-updated="true">Nov 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Performing a project-wide search-and-replace is a common task, and yet I still forget how to do it in Vim. While there&rsquo;s not that much to it (build an argument list of relevant files and run a global substitution across them), I&rsquo;ve had to look it up enough times to start wondering if there&rsquo;s a better way. I ended up writing a shell function, as well as a Ruby-specific wrapper for it.</p>

<p>Now if I want to rename a function across my project&rsquo;s javascript files, I can drop onto the command-line and run:</p>

<pre><code>$ greplace **.js uglyFunctionName nicerFunctionName
</code></pre>

<p>Or, if I&rsquo;m renaming a Ruby method:</p>

<pre><code>$ rupl bad_method_name good_method_name
</code></pre>

<h2>The Sauce</h2>

<p>Using <code>find</code>, <code>grep</code>, and <code>sed</code> in concert, we declare which files to search, what to search for, and what to do with those files that contain a match.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>greplace<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> !<span class="o">=</span> 3 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Usage: greplace file_pattern search_pattern replacement&quot;</span>
</span><span class='line'>    <span class="k">return </span>1
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nv">file_pattern</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'>    <span class="nv">search_pattern</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'>    <span class="nv">replacement</span><span class="o">=</span><span class="nv">$3</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># This is built for BSD grep and the sed bundled with OS X.</span>
</span><span class='line'>    <span class="c"># GNU grep takes -Z instead of --null, and other versions of sed may not support the -i &#39;&#39; syntax.</span>
</span><span class='line'>
</span><span class='line'>    find . -name <span class="s2">&quot;$file_pattern&quot;</span> -exec grep -lw --null <span class="s2">&quot;$search_pattern&quot;</span> <span class="o">{}</span> + |
</span><span class='line'>    xargs -0 sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s/[[:&lt;:]]$search_pattern[[:&gt;:]]/$replacement/g&quot;</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>rupl<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> !<span class="o">=</span> 2 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Usage: rupl search_pattern replacement&quot;</span>
</span><span class='line'>    <span class="k">return </span>1
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nv">search_pattern</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'>    <span class="nv">replacement</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'>
</span><span class='line'>    greplace <span class="s1">&#39;**.rb&#39;</span> <span class="s2">&quot;$search_pattern&quot;</span> <span class="s2">&quot;$replacement&quot;</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Ingredients</h2>

<p>The first thing <code>greplace</code> does is test whether it received the wrong number of arguments: <code>[ "$#" != 3 ]</code>. If so, we print a usage message and return an error code. Otherwise, we set some local variables with more memorable names than <code>1</code>, <code>2</code>, and <code>3</code>.</p>

<p>Next, we <code>find</code> pathnames in the current directory (and subdirectories) that match <code>file_pattern</code>. Using <code>find ... --exec &lt;command&gt; {};</code> lets us run a command on each found path, expanding <code>{}</code> to the pathname. Replacing <code>;</code> with <code>+</code> will instead expand <code>{}</code> to as many of the found pathnames as possible, which allows us to feed all the found files as arguments to a single <code>grep</code>.</p>

<p>We <code>grep</code> the relevant files for <code>search_pattern</code>, restricting results to the names of files (<code>-l</code>) that contain a whole-word (<code>-w</code>) match. We also print a <a href="http://en.wikipedia.org/wiki/Null_character">null-character</a> after each filename in the results (<code>--null</code>), which will be useful as a delimiter in the next step.</p>

<p>The results of <code>grep</code> are piped into <code>xargs -0</code>, which constructs an argument list (recognizing the null-character delimiter) and feeds this list to <code>sed</code> for further processing.</p>

<p>We then use <code>sed -i</code> to edit each file &ldquo;in place&rdquo; (rather than writing results to stdout) without creating any backup files (<code>''</code>), which could be risky, but since I&rsquo;m working with Git this seems reasonable.</p>

<p>The actual search-and-replace is simply a pattern substitution. The <code>[[:&lt;:]]</code> and <code>[[:&gt;:]]</code> delimiters restrict it to whole-word matches.</p>

<h2>Caveats</h2>

<p>A few things limit this function&rsquo;s portability. For one, not all versions of <code>grep</code> recognize the <code>--null</code> flag. GNU grep uses <code>-Z</code> instead. Also, the <code>-i ''</code> syntax may not be recognized by all versions of <code>sed</code> (actually, from what I was able to gather, that syntax might be unique to the version bundled with OSX).</p>

<p>That being said, it would only take a few minor tweaks to get this working on a different system.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/27/faster-specs/">Faster Specs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-27T22:23:00-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Getting the full benefits of <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a> requires fast-running specs. The feedback cycle is what makes the difference between a pleasurable &ldquo;red-green-refactor&rdquo; flow and an eternity of testing-tedium where the only reason you&rsquo;re <em>writing</em> tests is so you be <em>done</em> writing them. While TDD is lauded in the Rails community, many large Rails apps suffer from slow-running test suites.</p>

<p>I&rsquo;ve been working with a Rails app that has a couple of bloated, callback-ridden models. Much of the test-suite uses FactoryGirl, and generating test objects for those big models and their associations can slow things down to a crawl. So when a new feature came along, I took the opportunity to write some fast unit-tests in a different style.</p>

<h3>Couch-Surfer</h3>

<p>Imagine an app that logs the journeys of world-travellers (lots of them) as they couch-surf around the globe visiting homebody friends. Each traveller periodically sends a postcard to their next host to let them know how far off they are. We have a few persisted models: Traveller, Homebody, CouchCrash, and Postcard.</p>

<p>The Traveller and Homebody models are rather large, so I&rsquo;ve abbreviated them here:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Traveller</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:couch_crashes</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:homebodies</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:couch_crashes</span>
</span><span class='line'>  <span class="c1"># and many more associations, validations, callbacks...</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Homebody</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:couch_crashes</span>
</span><span class='line'>  <span class="c1"># and many more associations, validations, callbacks...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>CouchCrash and Postcard are pretty small, despite their associations with the larger models:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CouchCrash</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:traveller</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:homebody</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:postcards</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:traveller</span><span class="p">,</span> <span class="ss">:homebody</span><span class="p">,</span> <span class="ss">:arrival_date</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Postcard</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:traveller</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:couch_crash</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:homebody</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:couch_crash</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:traveller</span><span class="p">,</span> <span class="ss">:couch_crash</span><span class="p">,</span> <span class="ss">:distance</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each visit, or <code>couch_crash</code>, is scheduled with an <code>arrival_date</code>. But these aren&rsquo;t always accurate, as it&rsquo;s hard to know exactly when the traveller will reach their destination. We&rsquo;d like to add a feature that assesses the status of a visit as &ldquo;far off&rdquo;, &ldquo;approaching&rdquo;, or &ldquo;in progress&rdquo; based on the arrival date and available postcards. We won&rsquo;t bother with a &ldquo;completed&rdquo; status since couch-crashers have been known to stick around forever.</p>

<p>For simplicity&rsquo;s sake, we&rsquo;ll say any visit whose arrival date is more than a week away is &ldquo;far off&rdquo;. Within a week of the arrival date, an &ldquo;approaching&rdquo; status requires a postcard from within 100 miles and &ldquo;in Progress&rdquo; requires one within 5 miles (I know, that&rsquo;s a waste of a stamp). Otherwise, with either no postcards or only those over 100 miles away, the visit remains &ldquo;far off&rdquo;.</p>

<h3>Approaching the spec</h3>

<p>A spec for the &ldquo;approaching&rdquo; status using FactoryGirl might look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">CouchCrash</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s1">&#39;#status&#39;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s1">&#39;within 1 week of arrival date&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">context</span> <span class="s1">&#39;with a postcard from 100 miles away&#39;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">it</span> <span class="s1">&#39;is &quot;approaching&quot;&#39;</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">visit</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:couch_crash</span><span class="p">,</span> <span class="n">arrival_date</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">from_now</span><span class="p">)</span>
</span><span class='line'>          <span class="n">postcard_100</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:postcard</span><span class="p">,</span> <span class="ss">distance</span><span class="p">:</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">visit</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:postcards</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="o">[</span><span class="n">postcard_100</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">expect</span><span class="p">(</span><span class="n">visit</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:approaching</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using <code>build</code> rather than <code>create</code> should keep us from hitting the database. Stubbing the association between <code>visit</code> and its postcards should do the same. On the surface, this looks like a well-isolated, fast unit-test, but let&rsquo;s take a closer look at the factories we&rsquo;re using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># spec/factories/couch_crashes.rb</span>
</span><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:couch_crash</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">traveller</span>
</span><span class='line'>    <span class="n">homebody</span>
</span><span class='line'>    <span class="n">arrival_date</span> <span class="mi">2</span><span class="o">.</span><span class="n">weeks</span><span class="o">.</span><span class="n">from_now</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># spec/factories/post_cards.rb</span>
</span><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:post_card</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">traveller</span>
</span><span class='line'>    <span class="n">couch_crash</span>
</span><span class='line'>    <span class="n">distance</span> <span class="mi">300</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s best practice to define your factories with the minimum set of attributes necessary for a valid object. You don&rsquo;t want to set land-mines for the next developer that comes along and calls <code>create</code>. So the couch_crashes factory generates associated traveller and homebody objects. In doing so, it involves two of our most bloated models. Take a look at their factories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># spec/factories/travellers.rb</span>
</span><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:traveller</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">first_name</span> <span class="s2">&quot;Yngwie&quot;</span>
</span><span class='line'>    <span class="n">last_name</span>  <span class="s2">&quot;Malmsteen&quot;</span>
</span><span class='line'>    <span class="n">association</span> <span class="ss">:hometown</span><span class="p">,</span> <span class="ss">factory</span><span class="p">:</span> <span class="ss">:city</span>
</span><span class='line'>    <span class="n">luggage</span>
</span><span class='line'>    <span class="n">bicycle</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">after</span><span class="p">(</span><span class="ss">:build</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">traveller</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pump</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:bicycle_pump</span><span class="p">)</span>
</span><span class='line'>      <span class="n">traveller</span><span class="o">.</span><span class="n">bike_pump</span> <span class="o">=</span> <span class="n">pump</span>
</span><span class='line'>      <span class="n">traveller</span><span class="o">.</span><span class="n">inflate_tires</span>
</span><span class='line'>      <span class="n">traveller</span><span class="o">.</span><span class="n">pack_luggage</span>
</span><span class='line'>      <span class="n">traveller</span><span class="o">.</span><span class="n">buy_stamps</span>
</span><span class='line'>      <span class="c1"># etc.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># spec/factories/homebodies.rb</span>
</span><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:homebody</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">first_name</span> <span class="s2">&quot;Joe&quot;</span>
</span><span class='line'>    <span class="n">last_name</span>  <span class="s2">&quot;Stumps&quot;</span>
</span><span class='line'>    <span class="n">spouse</span>
</span><span class='line'>    <span class="n">credit_score</span> <span class="mi">400</span>
</span><span class='line'>    <span class="n">house</span>
</span><span class='line'>    <span class="n">couch</span>
</span><span class='line'>    <span class="n">car</span>
</span><span class='line'>    <span class="n">dog</span>
</span><span class='line'>    <span class="c1"># etc.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re also unintentionally hitting the database, as FactoryGirl saves both traveller and homebody in order to build the association. You can avoid this by specifying a build-strategy for the association:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">factory</span> <span class="ss">:couch_crash</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:traveller</span><span class="p">,</span> <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:homebody</span><span class="p">,</span>  <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;d also have to change the syntax in the associated factories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">factory</span> <span class="ss">:traveller</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:luggage</span><span class="p">,</span> <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:bicycle</span><span class="p">,</span> <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">factory</span> <span class="ss">:homebody</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:house</span><span class="p">,</span> <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:couch</span><span class="p">,</span> <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:car</span><span class="p">,</span>   <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:dog</span><span class="p">,</span>   <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would be nice to avoid involving these large models any more than necessary, so let&rsquo;s rewrite the spec with a different technique. Instead of using factories to generate complex test objects, we&rsquo;ll use test doubles to stub out the context.</p>

<h3>Test-doubles</h3>

<p>Rspec&rsquo;s <code>double</code> method returns a test-double &mdash; a dummy object that stands in for a more complex object from your production code. The double can be told how to respond to various method calls:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">red_thing</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># The argument (ie. &quot;thing&quot;) is optional.</span>
</span><span class='line'><span class="c1"># It provides a name that test output can make use of.</span>
</span><span class='line'>
</span><span class='line'><span class="n">red_thing</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:color</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># equivalent form:</span>
</span><span class='line'><span class="n">red_thing</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:color</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;red&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Or, more concisely:</span>
</span><span class='line'><span class="n">red_house</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">,</span> <span class="ss">color</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The double only knows what it&rsquo;s been told explicitly, and will raise an error upon receiving any unexpected method call. If you&rsquo;re using Rspec 3, you can also use &ldquo;<a href="https://www.relishapp.com/rspec/rspec-mocks/v/3-1/docs/verifying-doubles">verifying doubles</a>&rdquo;, which know what class of object they&rsquo;re standing in for and will ensure that any methods being stubbed are actually present in the code.</p>

<h3>Rewrite</h3>

<p>While our spec should still read from the ground up, beginning with the context and arriving at an expectation, it can be helpful when <em>writing</em> to start with the expectation and work backwards. This is especially true when the context is complex. It also helps clarify what needs to be stubbed out, so let&rsquo;s give it a shot.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">visit</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:approaching</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What is <code>visit</code>? Just a test double with the right attributes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">visit</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="n">arrival_date</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">from_now</span><span class="p">,</span> <span class="ss">postcards</span><span class="p">:</span> <span class="o">[</span><span class="n">postcard_100</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What about <code>postcard_100</code>? Just another test double.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">postcard_100</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">&quot;postcard&quot;</span><span class="p">,</span> <span class="ss">distance</span><span class="p">:</span> <span class="mi">100</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Putting it all together, we have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s1">&#39;within 1 week of arrival date&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">context</span> <span class="s1">&#39;with a postcard from 100 miles away&#39;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;is &quot;approaching&quot;&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">postcard_100</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">&quot;postcard&quot;</span><span class="p">,</span> <span class="ss">distance</span><span class="p">:</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>      <span class="n">visit</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">&quot;visit&quot;</span><span class="p">,</span> <span class="n">arrival_date</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">from_now</span><span class="p">,</span> <span class="ss">postcards</span><span class="p">:</span> <span class="o">[</span><span class="n">postcard_100</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">visit</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:approaching</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I initially wanted faster specs to enable a better TDD flow. A nice side benefit of writing these stubbed tests is that it illuminates the dependencies and coupling in the production code you&rsquo;re working with and encourages better composition overall. FactoryGirl is still a wonderful tool, but it shouldn&rsquo;t be the only one in your belt.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/26/vim-key-mappings/">Vim Key-mappings</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-26T12:04:00-04:00" pubdate data-updated="true">Oct 26<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>:map</h3>

<p>In the land of Vim, most key sequences can easily be mapped to others. The basic syntax is <code>map a b</code>, which tells Vim that when you type <code>a</code>, it should act like <code>b</code>. Similarly, <code>map abc wxyz</code> would process <code>wxyz</code> when you typed <code>abc</code>, but let&rsquo;s look at a more useful example.</p>

<p>You can use <code>m</code> to set a mark at the current cursor position, then jump to it later using the backtick (<code>`</code>) key. Take this buffer for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">penguify</span><span class="p">(</span><span class="n">being</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Penguin</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">being</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">NameError</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Can&#39;t penguify massless being.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll put my cursor on the <em>N</em> in <code>NameError</code> and type (in normal mode) <code>mx</code>. This sets a mark we can jump to by typing <code>`x</code>. This is nice, but the backtick isn&rsquo;t the most comfortable key to reach for.</p>

<p>There&rsquo;s a similar command using the single-quote. Typing <code>'x</code> jumps to the first non-whitespace character on the marked line. Probably not as useful. Let&rsquo;s map the more reachable <code>'</code> to the more useful <code>`</code>.</p>

<p>On Vim&rsquo;s command-line, enter: <code>map ' `</code>. Now both <code>`</code> and <code>'</code> will take us directly to our mark. Instead of ditching the single-quote&rsquo;s original command entirely, let&rsquo;s map the backtick to it with <code>map ` '</code>. But this causes a problem. Hit either <code>`</code> or <code>'</code> and you&rsquo;ll get an error (<code>E223: recursive mapping</code>). We&rsquo;ve mapped <code>`</code> to <code>'</code>, which triggers <code>`</code>, which triggers <code>'</code>, and on and on.</p>

<h3>:noremap</h3>

<p>To recover, let&rsquo;s remove both mappings with <code>unmap `</code> and <code>unmap '</code>, to start fresh. Now instead of using <code>map</code> we&rsquo;ll use <code>noremap</code>. Running <code>noremap a b</code> will map <code>a</code> to <code>b</code> but avoid triggering anything <code>b</code> is mapped to. So we can enter <code>noremap ' `</code> and <code>noremap ` '</code> to swap our keys without falling into a recursive pit.</p>

<h3>map-modes</h3>

<p>Depending on how you define them, your key-mappings will only apply in certain modes. The mappings we created with <code>map</code> and <code>noremap</code> apply in Normal, Visual, Select, and Operator-pending modes. Note the absence of Insert mode in that list &mdash; we&rsquo;re not in danger of inserting <code>doesn`t</code> when we wanted <code>doesn't</code>.</p>

<p>The <code>map</code>, <code>noremap</code>, and <code>unmap</code> commands each have mode-specific variations. My .vimrc, for instance, has a mapping for line-completion in Insert mode:</p>

<pre><code>inoremap &lt;C-L&gt; &lt;C-X&gt;&lt;C-L&gt;
</code></pre>

<p>The <code>&lt;C-L&gt;</code> represents Control-L, and is case-insensitive (same as <code>&lt;c-l&gt;</code>). This makes line-completion less cumbersome without polluting modes other than Insert with the mapping. For more on map-modes, check out <code>:help :map-modes</code>. The map-overview (<code>:help map-overview</code>) is a good place to start.</p>

<h3>key-notation</h3>

<p>Vim uses a special notation for some keys. We saw <code>&lt;C-L&gt;</code> already. There&rsquo;s also <code>&lt;Left&gt;</code>, <code>&lt;S-Left&gt;</code> (shift-left), <code>&lt;Space&gt;</code>, <code>&lt;CR&gt;</code> (carriage return / enter), and many more (see <code>:help key-notation</code>). We can use these to expand our key-mapping vocabulary.</p>

<h3>editor-envy</h3>

<p>I noticed a feature in Sublime Text that I wanted to simulate in Vim: <code>⌘Enter</code> adds a newline to the <em>end</em> of the current line rather than inserting it at the cursor position. This is handy if you&rsquo;re in the middle of a line and want to open a new line beneath it without breaking the text the cursor&rsquo;s on.</p>

<p>To similate this, I needed to <code>inoremap</code> something to <code>&lt;C-O&gt;o</code>. From Insert mode, <code>&lt;C-O&gt;</code> pops you into Normal mode for a single command. Once there, <code>o</code> opens a new line beneath the current one and drops you onto it in Insert mode. In the interest of portability, I decided against using the <code>⌘</code> key, since it&rsquo;s Mac-specific, and went with Control instead:</p>

<pre><code>inoremap &lt;C-CR&gt; &lt;C-O&gt;o
</code></pre>

<p>Now I can hit Control-Enter from Insert mode to drop down to a new line without disrupting the one I&rsquo;m on. Actually no, I can&rsquo;t. I can if I&rsquo;m using MacVim, but terminal Vim doesn&rsquo;t recognize the <code>&lt;C-CR&gt;</code> key-combo. This is where things get interesting.</p>

<h3>terminal keycodes</h3>

<p>To get the <code>&lt;C-CR&gt;</code> key-mapping to work in terminal Vim, I needed to first tell iTerm what to send when I hit Control-Enter, then tell Vim what to listen for and how to interpret it. Let&rsquo;s start with iTerm. The steps for Terminal.app are similar, though the menus and appearance will differ.</p>

<p>In iTerm&rsquo;s <em>Preferences</em> (<code>⌘,</code>), the <em>Profiles</em> tab has a <em>Keys</em> subtab. From there, you can define custom actions to trigger with any number of key-combinations. Clicking the &lsquo;<strong>+</strong>&rsquo; at the bottom of the list reveals a dialog to add a new combination.</p>

<p><img class="screenshot" src="/images/iterm/keys.png" title="keys" alt="iterm keys screenshot"></p>

<p>I hit Control-Enter to enter <code>^↩</code> in the <em>Keyboard Shortcut</em> field and selected <em>Send Escape Sequence</em> from the <em>Action</em> drop-down, revealing a field labeled &ldquo;Esc+&rdquo;. Here I entered <code>[25~</code>, telling iTerm to send Esc + <code>[25~</code> when Control-Enter is typed.</p>

<p>&ldquo;Why <code>[25~</code>? Where did that come from?&rdquo; I was hoping you wouldn&rsquo;t ask. Figuring out what codes to use, what wouldn&rsquo;t conflict with anything, and what would be interpretted consistently across xterm, GNU screen, and tmux was not a straightforward process. Lots of googling and trial and error, and recounting it is probably best saved for another post. For now, I&rsquo;ll stay focused on getting it wired up with Vim.</p>

<p>Next, I needed to tell Vim how to interpret the <code>^[[25~</code> escape sequence that iTerm would be sending its way. (Note that the initial <code>^[</code> is the Escape character itself.) I set an unused Function key to the escape sequence:</p>

<pre><code>set &lt;F13&gt;=^[[25~
</code></pre>

<p>To enter that command correctly, you need to type <code>set &lt;F13&gt;=</code>, hit Control-V, hit Escape, then finish with <code>[25~</code>. Control-V followed by Escape enters the actual terminal code for the Escape key (which <em>appears</em> as the single character <code>^[</code>). The same is true whether you&rsquo;re entering it on Vim&rsquo;s command-line or inserting it in your .vimrc.</p>

<p>With Vim listening for the escape sequence and associating it with a key, I mapped that key to <code>&lt;C-CR&gt;</code>:</p>

<pre><code>map  &lt;F13&gt; &lt;C-Cr&gt;  
map! &lt;F13&gt; &lt;C-Cr&gt;
</code></pre>

<p>The call to <code>map</code> applies the mapping in Normal, Visual, Select, and Operator-pending mappings, while <code>map!</code> applies to Insert and Command-line mappings. With all this in place, terminal Vim can recognize Control-Enter and the <code>&lt;C-CR&gt;</code> key-notation.</p>

<p>You can apply this approach to a lot of other key&rsquo;s that would otherwise be off-limits. A section of my <a href="https://github.com/ivanbrennan/vim/blob/master/vimrc">vimrc</a> wires up a bunch of them. I&rsquo;m cutting down on the mappings these days, but it&rsquo;s nice to know you can do this:</p>

<pre><code>if &amp;term =~ "xterm" || &amp;term =~ "screen" || &amp;term =~ "builtin_gui"
  " Ctrl-Enter
  set  &lt;F13&gt;=[25~
  map  &lt;F13&gt; &lt;C-CR&gt;
  map! &lt;F13&gt; &lt;C-CR&gt;

  " Shift-Enter
  set  &lt;F14&gt;=[27~
  map  &lt;F14&gt; &lt;S-CR&gt;
  map! &lt;F14&gt; &lt;S-CR&gt;

  " Ctrl-Space
  set  &lt;F15&gt;=[29~
  map  &lt;F15&gt; &lt;C-Space&gt;
  map! &lt;F15&gt; &lt;C-Space&gt;

  " Shift-Space
  set  &lt;F16&gt;=[30~
  map  &lt;F16&gt; &lt;S-Space&gt;
  map! &lt;F16&gt; &lt;S-Space&gt;

  " Ctrl-Backspace
  set  &lt;F17&gt;=[1;5P
  map  &lt;F17&gt; &lt;C-BS&gt;
  map! &lt;F17&gt; &lt;C-BS&gt;

  " Alt-Tab
  set  &lt;F18&gt;=[1;5Q
  map  &lt;F18&gt; &lt;M-Tab&gt;
  map! &lt;F18&gt; &lt;M-Tab&gt;

  " Alt-Shift-Tab
  set  &lt;F19&gt;=[1;5R
  map  &lt;F19&gt; &lt;M-S-Tab&gt;
  map! &lt;F19&gt; &lt;M-S-Tab&gt;

  " Ctrl-Up
  set  &lt;F20&gt;=[1;5A
  map  &lt;F20&gt; &lt;C-Up&gt;
  map! &lt;F20&gt; &lt;C-Up&gt;

  " Ctrl-Down
  set  &lt;F21&gt;=[1;5B
  map  &lt;F21&gt; &lt;C-Down&gt;
  map! &lt;F21&gt; &lt;C-Down&gt;

  " Ctrl-Right
  set  &lt;F22&gt;=[1;5C
  map  &lt;F22&gt; &lt;C-Right&gt;
  map! &lt;F22&gt; &lt;C-Right&gt;

  " Ctrl-Left
  set  &lt;F23&gt;=[1;5D
  map  &lt;F23&gt; &lt;C-Left&gt;
  map! &lt;F23&gt; &lt;C-Left&gt;

  " Ctrl-Tab
  set  &lt;F24&gt;=[31~
  map  &lt;F24&gt; &lt;C-Tab&gt;
  map! &lt;F24&gt; &lt;C-Tab&gt;

  " Ctrl-Shift-Tab
  set  &lt;F25&gt;=[32~
  map  &lt;F25&gt; &lt;C-S-Tab&gt;
  map! &lt;F25&gt; &lt;C-S-Tab&gt;

  " Ctrl-Comma
  set  &lt;F26&gt;=[33~
  map  &lt;F26&gt; &lt;C-,&gt;
  map! &lt;F26&gt; &lt;C-,&gt;

  " Ctrl-Shift-Space
  set  &lt;F27&gt;=[34~
  map  &lt;F27&gt; &lt;C-S-Space&gt;
  map! &lt;F27&gt; &lt;C-S-Space&gt;
endif
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/16/rigging-vims-netrw/">Rigging Vim&#8217;s Netrw</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-16T01:00:00-05:00" pubdate data-updated="true">Jan 16<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you&rsquo;re a Vim user, you&rsquo;re probably familiar with the <a href="http://www.vim.org/scripts/script.php?script_id=1075">NERDTree</a>, a plugin that provides a sidebar for navigating the filesystem, much like you get with a more graphical editor such as Sublime Text. It&rsquo;s a nice feature, but you don&rsquo;t necessarily need to install another plugin to get it. Most distributions of Vim come with <a href="http://www.vim.org/scripts/script.php?script_id=1075">Netrw</a> already built in. Built by <a href="http://www.drchip.org/astronaut/index.html">Charles CampBell</a>, Netrw is a plugin for browsing, reading, and writing files both locally and across networks.</p>

<p>Netrw is not NERDTree. It does much more, but the flip side is that NERDTree focuses on doing one thing well. That being said, at some point I got interested in reproducing what I liked about NERDTree using the built-in capabilities of Netrw. It took a bit of configuration and some dirty language (vimscript) but if you&rsquo;re not averse to any of that, read on.</p>

<p><img class="screenshot" src="/images/vextoggle/4.png" title="vim" alt="vim screenshot"></p>

<p>My first goal was to toggle a sidebar navigator open/closed with a keystroke or two. The <code>:Vexplore</code> command opens a Netrw browser in a vertical split. If you pass the command a directory, it will open into that location, otherwise it opens in the current file&rsquo;s parent directory. There&rsquo;s a distinction between the current file&rsquo;s parent directory and the &ldquo;current working directory&rdquo; that Vim keeps track of. Say you start Vim from within ~/Development. You can <code>:edit</code> files anywhere you like (~/Development/resources, ~, /usr/local, etc.), and until you explicitly tell Vim to <code>:cd</code> to a new location, the current working directory will remain where it started, at ~/Development. You can use this as a home-base to work from in the current Vim session. With this in mind, I composed a small set of functions to toggle the sidebar in either the current file&rsquo;s directory (to access neighboring files), or the &ldquo;current working directory&rdquo; (which I tend to leave at the project root), and mapped them to a couple keystrokes I find convenient.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">fun</span><span class="p">!</span> VexToggle<span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> exists<span class="p">(</span><span class="s2">&quot;t:vex_buf_nr&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">call</span> VexClose<span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">call</span> VexOpen<span class="p">(</span><span class="k">a</span>:<span class="nb">dir</span><span class="p">)</span>
</span><span class='line'>  <span class="k">endif</span>
</span><span class='line'><span class="k">endf</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m using <code>t:vex_buf_nr</code> to track whether the sidebar is currently open. The <code>t:</code> is scoping the variable to the current tab. That&rsquo;s so each tab can have its own sidebar. If you&rsquo;re not familiar with Vim&rsquo;s tabs, don&rsquo;t worry about it. It&rsquo;s a minor detail here. In the else clause, we pass <code>a:dir</code> (the <code>dir</code> argument that was passed into <code>VexToggle()</code>) to <code>VexOpen()</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">fun</span><span class="p">!</span> VexOpen<span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
</span><span class='line'>  <span class="k">let</span> <span class="k">g</span>:netrw_browse_split<span class="p">=</span><span class="m">4</span>    <span class="c">&quot; open files in previous window</span>
</span><span class='line'>  <span class="k">let</span> vex_width <span class="p">=</span> <span class="m">25</span>
</span><span class='line'>
</span><span class='line'>  execute <span class="s2">&quot;Vexplore &quot;</span> . <span class="k">a</span>:<span class="nb">dir</span>
</span><span class='line'>  <span class="k">let</span> <span class="k">t</span>:vex_buf_nr <span class="p">=</span> bufnr<span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">wincmd</span> H
</span><span class='line'>
</span><span class='line'>  <span class="k">call</span> VexSize<span class="p">(</span>vex_width<span class="p">)</span>
</span><span class='line'><span class="k">endf</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>VexOpen()</code> starts by setting some options. &ldquo;Open files in previous window&rdquo; ensures that when we select a file to open, it opens in the window (split) we were in before entering the browser. We&rsquo;re also setting the desired window width for later use.</p>

<p>Next, we use vimscript&rsquo;s string concatenation operator (<code>.</code>) to compose the <code>Vexplore</code> call. It&rsquo;s a little ugly, but sometimes vimscript paints you into a corner like that. Now that we have an explorer open, let&rsquo;s remember it (the next line). The <code>"%"</code> expands to the current file name, and we store the associated buffer number for later reference.</p>

<p>If you have several splits open, calling <code>:Vexplore</code> will open a Netrw explorer in a vertical split next to <em>the current split</em>, so there&rsquo;s no guarantee it will sit on the far left of the screen or even occupy the full height of Vim. Calling <code>wincmd H</code> fixes that. Finally, calling <code>VexSize()</code> will set the sidebar&rsquo;s width.</p>

<p>I made a couple mappings to call <code>VexToggle()</code>. The first passes it Vim&rsquo;s &ldquo;current working directory&rdquo; as an argument, while the second passes an empty string. That way, I can use the first mapping to toggle an explorer sidebar from the project root and the second to toggle an explorer from whichever directory houses the file I&rsquo;m currently editing.</p>

<pre><code>noremap &lt;Leader&gt;&lt;Tab&gt; :call VexToggle(getcwd())&lt;CR&gt;
noremap &lt;Leader&gt;` :call VexToggle("")&lt;CR&gt;
</code></pre>

<p><img class="screenshot" src="/images/vextoggle/8.png" title="vim" alt="vim screenshot"></p>

<p>When the sidebar is open, either mapping can be used to close it. <code>VexClose()</code> starts by noting which window it was called from, so it can return the cursor to that window after the sidebar has closed. The exception is when the cursor was <em>in</em> the sidebar when <code>VexClose()</code> was called, in which case the cursor will land in the previous window (whichever window holds the alternate file <code>"#"</code>). The middle section switches to the sidebar, closes it, and removes the internal variable that was tracking its presence. Finally, we switch to the appropriate destination window and call <code>NormalizeWidths()</code> to normalize the widths of all open windows. Note that we have to subtract 1 from the original window number that was stored, since closing the sidebar window decremented all the remaining window numbers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">fun</span><span class="p">!</span> VexClose<span class="p">()</span>
</span><span class='line'>  <span class="k">let</span> cur_win_nr <span class="p">=</span> winnr<span class="p">()</span>
</span><span class='line'>  <span class="k">let</span> target_nr <span class="p">=</span> <span class="p">(</span> cur_win_nr <span class="p">==</span> <span class="m">1</span> ? winnr<span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span> : cur_win_nr <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="m">1</span>wincmd <span class="k">w</span>
</span><span class='line'>  <span class="k">close</span>
</span><span class='line'>  unlet <span class="k">t</span>:vex_buf_nr
</span><span class='line'>
</span><span class='line'>  execute <span class="p">(</span>target_nr <span class="p">-</span> <span class="m">1</span><span class="p">)</span> . <span class="s2">&quot;wincmd w&quot;</span>
</span><span class='line'>  <span class="k">call</span> NormalizeWidths<span class="p">()</span>
</span><span class='line'><span class="k">endf</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="screenshot" src="/images/vextoggle/10.png" title="vim" alt="vim screenshot"></p>

<p>All that&rsquo;s left are the final touches to window sizing, which occur in <code>VexSize()</code> and <code>NormalizeWidths()</code>. The first function sets and locks the sidebar width, then calls the second to normalize the widths off all other windows. <code>NormalizeWidths()</code> is a little hacky, but as far as I can tell it&rsquo;s the only native vimscript way to normalize window widths without affecting their heights. <code>'eadirection'</code> controls which dimensions are affected when <code>'equal always'</code> is set. We set it to <code>hor</code> (horizontal), toggle <code>'equal always'</code> off and back on (it&rsquo;s on by default), triggering the width normalization, and finally restore <code>'eadirection'</code> to it&rsquo;s original value.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">fun</span><span class="p">!</span> VexSize<span class="p">(</span>vex_width<span class="p">)</span>
</span><span class='line'>  execute <span class="s2">&quot;vertical resize&quot;</span> . <span class="k">a</span>:vex_width
</span><span class='line'>  <span class="k">set</span> <span class="nb">winfixwidth</span>
</span><span class='line'>  <span class="k">call</span> NormalizeWidths<span class="p">()</span>
</span><span class='line'><span class="k">endf</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span><span class="p">!</span> NormalizeWidths<span class="p">()</span>
</span><span class='line'>  <span class="k">let</span> eadir_pref <span class="p">=</span> &amp;<span class="nb">eadirection</span>
</span><span class='line'>  <span class="k">set</span> <span class="nb">eadirection</span><span class="p">=</span>hor
</span><span class='line'>  <span class="k">set</span> <span class="nb">equalalways</span><span class="p">!</span> <span class="nb">equalalways</span><span class="p">!</span>
</span><span class='line'>  <span class="k">let</span> &amp;<span class="nb">eadirection</span> <span class="p">=</span> eadir_pref
</span><span class='line'><span class="k">endf</span>
</span></code></pre></td></tr></table></div></figure>


<p>Netrw lets you open a selected file in a vertical split with the <code>v</code> key, and I wanted to normalize window widths when such a split was added so things would remain evenly sized. The following autocommand makes it so.</p>

<pre><code>augroup NetrwGroup
  autocmd! BufEnter * call NormalizeWidths()
augroup END
</code></pre>

<p><img class="screenshot" src="/images/vextoggle/12.png" title="vim" alt="vim screenshot"></p>

<p><strong><em>Closing Notes</em></strong></p>

<p>I ran into a couple minor bugs in Netrw during all of this, and turned to the <a href="https://groups.google.com/forum/#!topic/vim_use/XNOcLYsgk8Y">vim_use</a> mailing list for help. Netrw&rsquo;s author (Dr. Chip) was quick to respond with a fix and point me toward the <a href="http://www.drchip.org/astronaut/vim/index.html#NETRW">newest version</a>. Big thanks Dr. Chip!</p>

<p>I find myself mostly using Netrw&rsquo;s &ldquo;thin&rdquo; liststyle rather than the &ldquo;tree&rdquo; style I originally liked, but both work equally well in the sidebar. Finally, my <a href="https://github.com/ivanbrennan/vim/blob/master/vimrc">vimrc</a> is available for reference, though the relevant Netrw settings I&rsquo;m using are pasted below:</p>

<pre><code>let g:netrw_liststyle=0         " thin (change to 3 for tree)
let g:netrw_banner=0            " no banner
let g:netrw_altv=1              " open files on right
let g:netrw_preview=1           " open previews vertically
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/14/polymorphic-mythology/">Polymorphic Mythology</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-14T17:33:00-05:00" pubdate data-updated="true">Jan 14<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was recently introduced to polymorphic associations in Active Record. They provide some extra flexibility in how you choose to wire up your models, and can be an elegant solution to some otherwise awkward problems. To demonstrate, I&rsquo;ll show how you could use them to catalog a collection of mythology.</p>

<p>We&rsquo;ll start with a tiny collection of tales: The Reign of the Hydra, The Golden Voyage, and The Life of King Adrastus. In addition to needing a myth model, we&rsquo;ll need models for beasts, voyages, and heros. Let&rsquo;s set things up so that a character/event/etc. can be the central figure in any number of myths, with each myth centered around a single such figure. Our beast model, then, could simply be,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Beast</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:myths</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>backed by a straightforward migration,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateBeasts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:beasts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But wiring up the myth model isn&rsquo;t so simple. We could write three <code>belongs_to</code> statements into <code>myth.rb</code>, create three columns &mdash; beast_id, voyage_id, and hero_id &mdash; in the myths table, and find a way to enforce that two of the three always hold null values, but that&rsquo;s pretty cumbersome. Plus, as our catalog expands and we discover new types of central-figures (fools, floods, fires), we&rsquo;ll have to add more columns to accommodate any new classes we create. That&rsquo;s a lot of work to store a whole lot of nils.</p>

<p>Polymorphic associations allow you to handle this more elegantly. Let&rsquo;s describe the role that our central-figure plays in the context of a myth. For lack of a better term, I&rsquo;ll call it &ldquo;memorable&rdquo;. A dragon ravishing the countryside, an epic voyage, a tragic hero, these are all &ldquo;memorable&rdquo; things that could take center-stage in a myth. Using this common thread, we&rsquo;ll build a polymorphic association that can relate a myth to any such &ldquo;memorable&rdquo; object.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Myth</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:memorable</span><span class="p">,</span> <span class="ss">:polymorphic</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At the other end of the association, we&rsquo;ll tweak the <code>has_many</code> statements in each of our &ldquo;memorable&rdquo; models, declaring the role they can play in relation to a myth. The beast model, for example, becomes</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Beast</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:myths</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:memorable</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can back the myth model with a much simpler table. The &ldquo;memorable&rdquo; central-figure&rsquo;s id and its type will be stored in a pair of columns, providing a myth with all it needs (a foreign key and the table that key applies to) to retrieve its central-figure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateMyths</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:myths</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:name</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:memorable_id</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:memorable_type</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Active Record provides a shorthand for creating such a pair of columns: <code>t.references :memorable, :polymorphic =&gt; true</code>, which we could use in place of lines 6 and 7 above.</p>

<p>The polymorphic association allows us to create associations between existing objects,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">adrastus</span> <span class="o">=</span> <span class="no">Hero</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Adrastus&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">life</span> <span class="o">=</span> <span class="no">Myth</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;The Life of King Adrastus&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">life</span><span class="o">.</span><span class="n">memorable</span> <span class="o">=</span> <span class="n">adrastus</span>
</span><span class='line'>
</span><span class='line'><span class="n">afterlife</span> <span class="o">=</span> <span class="no">Myth</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;The Afterlife of King Adrastus&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">adrastus</span><span class="o">.</span><span class="n">myths</span> <span class="o">&lt;&lt;</span> <span class="n">afterlife</span>
</span></code></pre></td></tr></table></div></figure>


<p>and to build associated myths off of a given &ldquo;memorable&rdquo; object,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">adrastus</span><span class="o">.</span><span class="n">myths</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Adrastus - The Prequel&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">adrastus</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>
</span><span class='line'><span class="n">adrastus</span><span class="o">.</span><span class="n">myths</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Adrastus IV - The Return&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note, however, that we can&rsquo;t build a &ldquo;memorable&rdquo; object off of a given myth, since the type of object (hero, voyage, etc.) is ambiguous.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/21/chef-roles/">Chef Roles</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-21T09:11:00-05:00" pubdate data-updated="true">Nov 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It took me a while to wrap my head around a Chef role. It sounds simple enough at first &mdash; a collection of recipes that allows a node to act in a certain capacity, as say, a Redis server &mdash; but Chef also deals in cookbooks, which are also collections of recipes. So then what&rsquo;s the difference between a cookbook and a role?</p>

<p>A cookbook is a collection of recipes relating to a particular piece of technology. The nginx cookbook, for example, contains several recipes related to building and configuring nginx: <code>nginx::source</code> builds nginx from source, <code>nginx::ohai_plugin</code> provides the Ohai plugin as a template, <code>nginx::passenger</code> builds the passenger gem, etc.</p>

<p>A node is a single server, and Chef can apply a variety of recipes to the node to set it up as needed. Those recipes can be selected from a variety of cookbooks, and we don&rsquo;t have to use every recipe in a given cookbook. So how do we package the particular mix of recipes we need for a certain type of node? In a role.</p>

<p>For lack of a better analogy, you could think of a role as a multi-course meal made from several recipes pulled from a variety of cookbooks. A couple from a Pasta cookbook, one from a French Cuisine cookbook, one from a Pastries cookbook. The meal won&rsquo;t be made from every single recipe in those books, just the desired ones.</p>

<p>Recipes can include each other too, like mixins in Ruby (the <code>nginx::source</code> recipe, for example, includes the <code>nginx::ohai_plugin</code> recipe as part of it) but let&rsquo;s not add to the confusion just yet.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/19/sandboxing-chef-solo/">Sandboxing Chef-solo</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-19T22:31:00-05:00" pubdate data-updated="true">Nov 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m in the early stages of a team project. Our goal is to build a rails app that uses <a href="http://docs.opscode.com/chef_solo.html">chef-solo</a> to automate the creation and provisioning of a DigitalOcean droplet, and deploys to it using <a href="https://github.com/capistrano/capistrano">Capistrano</a>. The idea is to let a user deploy their own app to a <a href="http://digitalocean.com/">DO</a> server using our app to do the heavy lifting.</p>

<p>We&rsquo;re new to chef-solo, and initially I tried plowing through documentation, hoping to build a comprehensive understanding before diving into the project. But we really needed to get our hands dirty to get a feel for chef, so we started sandboxing tiny prototypes. We were flying blind at times, but the small successes kept us moving forward.</p>

<p>The zeroth step was to install some necessary tools, namely knife-solo and berkshelf. knife-solo is the command line tool for chef-solo, and berkshelf plays a role similar to Bundler, managing dependencies within chef.</p>

<p>For our first sandbox venture, we took an existing, chef-ready <a href="https://github.com/TalkingQuickly/rails-server-template">rails server template</a> and used it to provision an existing server.</p>

<p>Next we created a project directory from scratch, initialized a chef repo within it, and cloned an existing cookbook into the cookbooks directory. Easier said than done, but the ascii-art made it all worth while.</p>

<p><img class="production" src="http://i.imgur.com/gEGr6LJ.jpg" title="production" alt="production"></p>

<p>These little exercises were helpful, but we were still bogged down trying to map out the components and configurations encompassed by Chef. We backed up, got some helpful input from the TA&rsquo;s here at Flatiron School, and started mapping out the components necessary to <em>our</em> project, pinpointing the core functionality we needed to start with.</p>

<p><img class="sketch" src="http://i.imgur.com/oih6feU.jpg" title="sketch" alt="sketch"></p>

<h3>Step 1: Get a local chef repo communicating with DigitalOcean</h3>

<p>It turns out there&rsquo;s a plugin just for that: <a href="https://github.com/rmoriz/knife-digital_ocean">knife-digital_ocean</a>. We had to put our API-credentials from DigitalOcean into <code>knife.rb</code>, a configuration file for chef-solo, and add our SSH key to the DO account. Then we were able to create a new DO droplet with the desired OS and our SSH key, all in a single console command. Thank you knife-digital_ocean!</p>

<p>There&rsquo;s plenty more work ahead. Our rails app needs to:</p>

<ul>
<li>automate knife-digital_ocean commands</li>
<li>take user input

<ul>
<li>Github url for the app they want to deploy</li>
<li>necessary credentials (handle the SSH keys)</li>
</ul>
</li>
<li>run provisioning as a background process (it takes a while)</li>
<li>deploy with Capistrano</li>
</ul>


<p>It feels much more manageable with step 1 behind us and the skeleton of the project sketched out. Still, I&rsquo;m sure I&rsquo;ll be spending some more quality time in the Chef documentation.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/12/20/debugging-etags/">Debugging-etags</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/06/karabiner/">Karabiner</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/04/unix-know-how/">Unix Know-how</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/04/search-and-replace/">Search &amp; Replace</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/27/faster-specs/">Faster Specs</a>
      </li>
    
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Ivan Brennan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codemachine';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
